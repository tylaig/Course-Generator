import { Express } from "express";
import { createServer, Server } from "http";
import { z } from "zod";
import { storage } from "./storage";
import { generateStrategy, generateStructure, generateCompetencyMapping } from "./openai";
import { getAuthUrl, getTokenFromCode, generateAndUploadCourse } from "./googleDrive";

// Validation schemas
const courseDetailsSchema = z.object({
  title: z.string().min(3),
  theme: z.string().min(3),
  estimatedHours: z.number().min(1),
  format: z.string().min(1),
  platform: z.string().min(1),
  deliveryFormat: z.string().min(1),
  publicTarget: z.string().optional(),
  educationalLevel: z.string().optional(),
  familiarityLevel: z.string().optional(),
  motivation: z.string().optional(),
  cognitiveSkills: z.string().optional(),
  behavioralSkills: z.string().optional(),
  technicalSkills: z.string().optional()
});

export async function registerRoutes(app: Express): Promise<Server> {
  const httpServer = createServer(app);
  
  // ---- Course CRUD Routes ----
  app.get("/api/courses", async (req, res) => {
    try {
      const courses = await storage.listCourses();
      res.json(courses);
    } catch (error) {
      console.error("Erro ao listar cursos:", error);
      res.status(500).json({ error: "Falha ao listar cursos" });
    }
  });

  app.post("/api/courses", async (req, res) => {
    try {
      const courseData = {
        title: req.body.title || "Novo Curso",
        theme: req.body.theme || "Tema Geral",
        estimatedHours: req.body.estimatedHours || 10,
        format: req.body.format || "Online",
        platform: req.body.platform || "Web",
        deliveryFormat: req.body.deliveryFormat || "PDF",
        currentPhase: 1
      };
      
      const course = await storage.createCourse(courseData);
      res.json(course);
    } catch (error) {
      console.error("Erro ao criar curso:", error);
      res.status(500).json({ error: "Falha ao criar curso" });
    }
  });

  app.get("/api/courses/:id", async (req, res) => {
    try {
      const courseId = req.params.id;
      console.log("Fetching course with ID:", courseId);
      
      // Validate courseId format
      if (!courseId || courseId === 'undefined' || courseId === 'null') {
        return res.status(400).json({ error: "Invalid course ID" });
      }
      
      const course = await storage.getCourse(courseId);
      if (!course) {
        return res.status(404).json({ error: "Course not found" });
      }
      res.json(course);
    } catch (error) {
      console.error("Erro ao buscar curso:", error);
      res.status(500).json({ error: "Falha ao buscar curso" });
    }
  });

  app.put("/api/courses/:id", async (req, res) => {
    try {
      const course = await storage.updateCourse(req.params.id, req.body);
      if (!course) {
        return res.status(404).json({ error: "Curso n√£o encontrado" });
      }
      res.json(course);
    } catch (error) {
      console.error("Erro ao atualizar curso:", error);
      res.status(500).json({ error: "Falha ao atualizar curso" });
    }
  });

  // ---- Phase Data Routes ----
  app.get("/api/courses/:courseId/phase/:phaseNumber", async (req, res) => {
    try {
      const phaseData = await storage.getPhaseData(req.params.courseId, parseInt(req.params.phaseNumber));
      res.json(phaseData || {});
    } catch (error) {
      console.error("Erro ao buscar dados da fase:", error);
      res.status(500).json({ error: "Falha ao buscar dados da fase" });
    }
  });

  app.post("/api/courses/:courseId/phase/:phaseNumber", async (req, res) => {
    try {
      console.log("Par√¢metros recebidos:", req.params);
      console.log("Body recebido:", req.body);
      
      // O courseId vem como "course_timestamp", mas precisamos usar o ID real do banco
      const courseIdStr = req.params.courseId;
      
      // Buscar o curso real no banco para pegar o ID correto
      const courses = await storage.listCourses();
      const course = courses.find(c => c.title === "Novo Curso Educacional"); // Usar uma busca mais espec√≠fica
      
      if (!course) {
        console.log("Curso n√£o encontrado para:", courseIdStr);
        return res.status(404).json({ error: "Curso n√£o encontrado" });
      }
      
      const courseId = course.id; // Usar o ID real do banco (1, 2, 3, etc.)
      console.log("Course ID original:", courseIdStr);
      console.log("Course ID do banco:", courseId);
      
      const phaseNumber = parseInt(req.params.phaseNumber);
      console.log("Phase number:", phaseNumber);
      
      const data = {
        courseId: courseId, // Agora usando o ID real do banco (1, 2, 3...)
        phaseNumber: phaseNumber,
        content: req.body
      };
      
      console.log("Dados para salvar:", data);
      
      const phaseData = await storage.createPhaseData(data);
      res.json(phaseData);
    } catch (error) {
      console.error("Erro detalhado ao salvar dados da fase:", error);
      res.status(500).json({ error: "Falha ao salvar dados da fase" });
    }
  });

  // ---- Strategy Generation (Phase 1) ----
  app.post("/api/courses/strategy", async (req, res) => {
    try {
      if (!req.body.title || !req.body.theme) {
        return res.status(400).json({ 
          success: false,
          message: "Campos obrigat√≥rios faltando. T√≠tulo e tema s√£o necess√°rios." 
        });
      }
      
      const courseDetails = {
        title: req.body.title,
        theme: req.body.theme,
        estimatedHours: req.body.estimatedHours || 10,
        format: req.body.format || "Online",
        platform: req.body.platform || "Web",
        deliveryFormat: req.body.deliveryFormat || "PDF",
        publicTarget: req.body.publicTarget,
        educationalLevel: req.body.educationalLevel,
        familiarityLevel: req.body.familiarityLevel,
        motivation: req.body.motivation,
        cognitiveSkills: req.body.cognitiveSkills,
        behavioralSkills: req.body.behavioralSkills,
        technicalSkills: req.body.technicalSkills
      };
      
      const strategyData = await generateStrategy();
      
      res.json({
        success: true,
        strategy: strategyData
      });
    } catch (error) {
      console.error("Erro ao gerar estrat√©gia:", error);
      res.status(500).json({ 
        success: false,
        message: "Falha ao gerar estrat√©gia de curso",
        error: error instanceof Error ? error.message : "Erro desconhecido"
      });
    }
  });

  // ---- Structure Generation (Phase 2) ----
  app.post("/api/courses/structure", async (req, res) => {
    try {
      console.log("=== GERA√á√ÉO DE ESTRUTURA INICIADA ===");
      const { courseDetails, phaseData, moduleCount = 6, lessonsPerModule = 5 } = req.body;
      
      console.log("Configura√ß√µes recebidas:", { moduleCount, lessonsPerModule });
      
      const formattedDetails = {
        title: courseDetails.title || "Curso de JavaScript",
        theme: courseDetails.theme || "Programa√ß√£o",
        estimatedHours: courseDetails.estimatedHours || 40,
        format: courseDetails.format || "Online",
        platform: courseDetails.platform || "Web",
        deliveryFormat: courseDetails.deliveryFormat || "Ass√≠ncrono",
        moduleCount: moduleCount,
        lessonsPerModule: lessonsPerModule,
        publicTarget: courseDetails.publicTarget,
        educationalLevel: courseDetails.educationalLevel,
        familiarityLevel: courseDetails.familiarityLevel,
        motivation: courseDetails.motivation,
        cognitiveSkills: courseDetails.cognitiveSkills,
        behavioralSkills: courseDetails.behavioralSkills,
        technicalSkills: courseDetails.technicalSkills,
        courseLanguage: courseDetails.courseLanguage || "pt-BR"
      };
      
      console.log("üöÄ CHAMANDO generateStructure com:", JSON.stringify(formattedDetails, null, 2));
      const structureData = await generateStructure(formattedDetails, phaseData || {});
      console.log("üöÄ generateStructure RETORNOU:", structureData);
      
      console.log(`‚úÖ Estrutura gerada: ${structureData.modules?.length || 0} m√≥dulos`);
      
      res.json({
        success: true,
        modules: structureData.modules || []
      });
      
    } catch (error) {
      console.error("Erro na gera√ß√£o de estrutura:", error);
      res.status(500).json({ 
        message: "Falha ao gerar estrutura do curso", 
        error: error instanceof Error ? error.message : "Erro desconhecido" 
      });
    }
  });

  // ---- Competency Mapping Generation (Phase 2) ----
  app.post("/api/courses/competency-mapping", async (req, res) => {
    try {
      console.log("=== GERA√á√ÉO DE MAPEAMENTO DE COMPET√äNCIAS INICIADA ===");
      const { courseDetails, modules } = req.body;
      
      if (!modules || !Array.isArray(modules) || modules.length === 0) {
        return res.status(400).json({ error: "M√≥dulos s√£o obrigat√≥rios" });
      }
      
      console.log(`Mapeando compet√™ncias para ${modules.length} m√≥dulos`);
      
      const mappingData = await generateCompetencyMapping(modules, courseDetails);
      console.log("üéØ Mapeamento gerado:", JSON.stringify(mappingData, null, 2));
      
      // Garantir que sempre retornamos JSON v√°lido
      res.setHeader('Content-Type', 'application/json');
      res.json(mappingData);
      
    } catch (error) {
      console.error("Erro na gera√ß√£o de mapeamento:", error);
      res.status(500).json({ 
        message: "Falha ao gerar mapeamento de compet√™ncias", 
        error: error instanceof Error ? error.message : "Erro desconhecido" 
      });
    }
  });

  // ---- Lesson Content Generation (Phase 3) ----
  app.post("/api/generate/lesson-content", async (req, res) => {
    try {
      console.log("=== GERA√á√ÉO DE CONTE√öDO DE AULA INICIADA ===");
      const { lesson, module, courseDetails, aiConfig } = req.body;
      
      if (!lesson || !module || !courseDetails) {
        return res.status(400).json({ error: "Dados obrigat√≥rios n√£o fornecidos" });
      }
      
      console.log(`Gerando conte√∫do para aula: ${lesson.title}`);
      
      // Verificar se temos chave da OpenAI
      if (!process.env.OPENAI_API_KEY) {
        return res.status(500).json({ 
          error: "Chave da OpenAI n√£o configurada",
          message: "Configure a vari√°vel OPENAI_API_KEY para usar a gera√ß√£o avan√ßada de conte√∫do"
        });
      }

      // Usar OpenAI para gerar conte√∫do estruturado da aula
      const { generateAdvancedLessonContent } = await import('./openai');
      const lessonContent = await generateAdvancedLessonContent(
        lesson, 
        module, 
        courseDetails, 
        aiConfig
      );
      
      res.json({
        success: true,
        content: lessonContent
      });
      
    } catch (error) {
      console.error("Erro na gera√ß√£o de conte√∫do da aula:", error);
      res.status(500).json({ 
        message: "Falha ao gerar conte√∫do da aula", 
        error: error instanceof Error ? error.message : "Erro desconhecido" 
      });
    }
  });

  // Generate course PDF
  app.post("/api/generate/course-pdf", async (req, res) => {
    try {
      const { courseId } = req.body;
      
      const course = await storage.getCourse(courseId);
      if (!course) {
        return res.status(404).json({ error: "Course not found" });
      }

      const modules = await storage.listModulesByCourse(courseId);
      
      const { generateCoursePDF } = await import("./pdf-generator");
      
      const courseData = {
        title: course.title,
        theme: course.theme,
        modules: modules.map(module => ({
          id: module.id.toString(),
          title: module.title,
          description: module.description,
          content: module.content || { lessons: [] }
        }))
      };

      const pdfBuffer = await generateCoursePDF(courseData);
      
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Disposition', `attachment; filename="${course.title}.pdf"`);
      res.send(pdfBuffer);
    } catch (error) {
      console.error("Error generating course PDF:", error);
      res.status(500).json({ error: "Failed to generate PDF" });
    }
  });

  // Generate activities summary PDF
  app.post("/api/generate/activities-pdf", async (req, res) => {
    try {
      const { courseId } = req.body;
      
      const course = await storage.getCourse(courseId);
      if (!course) {
        return res.status(404).json({ error: "Course not found" });
      }

      const modules = await storage.listModulesByCourse(courseId);
      
      const { generateActivitySummaryPDF } = await import("./pdf-generator");
      
      const courseData = {
        title: course.title,
        theme: course.theme,
        modules: modules.map(module => ({
          id: module.id.toString(),
          title: module.title,
          description: module.description,
          content: module.content || { lessons: [] }
        }))
      };

      const pdfBuffer = await generateActivitySummaryPDF(courseData);
      
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Disposition', `attachment; filename="${course.title}_Atividades.pdf"`);
      res.send(pdfBuffer);
    } catch (error) {
      console.error("Error generating activities PDF:", error);
      res.status(500).json({ error: "Failed to generate activities PDF" });
    }
  });

  return httpServer;
}